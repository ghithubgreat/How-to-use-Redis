<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç† - å•†å“åº“å­˜ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .action-btn {
            margin-right: 5px;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .filter-btn {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-box-seam"></i> å•†å“åº“å­˜ç®¡ç†ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor/stock">åº“å­˜ç›‘æ§</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/product/list">å•†å“ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/order/list">è®¢å•ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor/redis-cache">Redisç¼“å­˜</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-box"></i> å•†å“ç®¡ç†</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="bi bi-plus-circle"></i> å‘å¸ƒå•†å“
            </button>
        </div>
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">å•†å“åˆ—è¡¨</h5>
                    <div>
                        <a th:class="${currentStatus == null} ? 'btn btn-sm btn-primary filter-btn' : 'btn btn-sm btn-outline-primary filter-btn'" 
                           href="/product/list">
                            å…¨éƒ¨å•†å“
                        </a>
                        <a th:class="${currentStatus != null && currentStatus == 1} ? 'btn btn-sm btn-primary filter-btn' : 'btn btn-sm btn-outline-primary filter-btn'" 
                           href="/product/list?status=1">
                            å·²ä¸Šæ¶
                        </a>
                        <a th:class="${currentStatus != null && currentStatus == 0} ? 'btn btn-sm btn-primary filter-btn' : 'btn btn-sm btn-outline-primary filter-btn'" 
                           href="/product/list?status=0">
                            å·²ä¸‹æ¶
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>å•†å“å›¾ç‰‡</th>
                                <th>å•†å“åç§°</th>
                                <th>ä»·æ ¼</th>
                                <th>åº“å­˜</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${products.empty}">
                                <td colspan="8" class="text-center">æš‚æ— å•†å“æ•°æ®</td>
                            </tr>
                            <tr th:each="product : ${products}">
                                <td th:text="${product.id}"></td>
                                <td>
                                    <img th:if="${product.imageUrl}" th:src="${product.imageUrl}" class="img-thumbnail" width="50" alt="å•†å“å›¾ç‰‡">
                                    <span th:unless="${product.imageUrl}" class="text-muted">æ— å›¾ç‰‡</span>
                                </td>
                                <td th:text="${product.name}"></td>
                                <td th:text="${'Â¥' + product.price}"></td>
                                <td th:text="${product.stock}"></td>
                                <td>
                                    <span th:if="${product.status == 1}" class="badge bg-success status-badge">ä¸Šæ¶ä¸­</span>
                                    <span th:unless="${product.status == 1}" class="badge bg-secondary status-badge">å·²ä¸‹æ¶</span>
                                </td>
                                <td th:text="${#temporals.format(product.createTime, 'yyyy-MM-dd HH:mm')}"></td>
                                <td>
                                    <!-- åªæœ‰ä¸Šæ¶å•†å“æ‰èƒ½æŸ¥çœ‹ -->
                                    <!-- ä¸Šæ¶å•†å“æ˜¾ç¤ºå¯ç‚¹å‡»çš„æŸ¥çœ‹æŒ‰é’® -->
                                    <button th:if="${product.status == 1}" class="btn btn-sm btn-info action-btn"
                                            th:onclick="|viewProduct(${product.id})|">
                                        <i class="bi bi-eye"></i> æŸ¥çœ‹
                                    </button>
                                    <!-- ä¸‹æ¶å•†å“æ˜¾ç¤ºç¦ç”¨çš„æŒ‰é’® -->
                                    <button th:unless="${product.status == 1}" class="btn btn-sm btn-secondary action-btn" disabled>
                                        <i class="bi bi-eye"></i> å·²ä¸‹æ¶
                                    </button>
                                    <button class="btn btn-sm btn-warning action-btn"
                                            th:onclick="|editProduct(${product.id})|">
                                        <i class="bi bi-pencil"></i> æ›´æ–°
                                    </button>
                                    <button th:if="${product.status == 1}" class="btn btn-sm btn-danger action-btn"
                                            th:onclick="|confirmRemoveProduct(${product.id})|">
                                        <i class="bi bi-archive"></i> ä¸‹æ¶
                                    </button>
                                    <button th:unless="${product.status == 1}" class="btn btn-sm btn-success action-btn"
                                            th:onclick="|restoreProduct(${product.id})|">
                                        <i class="bi bi-arrow-return-left"></i> ä¸Šæ¶
                                    </button>
                                    <button class="btn btn-sm btn-secondary action-btn"
                                            th:onclick="|clearProductCache(${product.id})|">
                                        <i class="bi bi-trash"></i> æ¸…é™¤ç¼“å­˜
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å•†å“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‘å¸ƒæ–°å•†å“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">å•†å“åç§°</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label">ä»·æ ¼</label>
                            <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="stock" class="form-label">åº“å­˜</label>
                            <input type="number" class="form-control" id="stock" name="stock" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="imageUrl" class="form-label">å›¾ç‰‡URL</label>
                            <input type="text" class="form-control" id="imageUrl" name="imageUrl">
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">å•†å“æè¿°</label>
                            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createProduct()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å•†å“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ›´æ–°å•†å“ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="edit-id" name="id">
                        <div class="mb-3">
                            <label for="edit-name" class="form-label">å•†å“åç§°</label>
                            <input type="text" class="form-control" id="edit-name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-price" class="form-label">ä»·æ ¼</label>
                            <input type="number" class="form-control" id="edit-price" name="price" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-stock" class="form-label">åº“å­˜</label>
                            <input type="number" class="form-control" id="edit-stock" name="stock" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-imageUrl" class="form-label">å›¾ç‰‡URL</label>
                            <input type="text" class="form-control" id="edit-imageUrl" name="imageUrl">
                        </div>
                        <div class="mb-3">
                            <label for="edit-description" class="form-label">å•†å“æè¿°</label>
                            <textarea class="form-control" id="edit-description" name="description" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="updateProduct()">ä¿å­˜æ›´æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹å•†å“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="viewProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å•†å“è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <img id="view-image" src="" class="img-fluid rounded" alt="å•†å“å›¾ç‰‡">
                        </div>
                        <div class="col-md-8">
                            <h4 id="view-name"></h4>
                            <p class="text-danger fw-bold" id="view-price"></p>
                            <div class="mb-3">
                                <span class="badge bg-info me-2">åº“å­˜: <span id="view-stock"></span></span>
                                <span id="view-status" class="badge me-2"></span>
                            </div>
                            <h5>å•†å“æè¿°</h5>
                            <p id="view-description"></p>
                            
                            <!-- æ·»åŠ è´­ä¹°åŒºåŸŸ -->
                            <div id="purchase-area" class="mt-4 p-3 border rounded bg-light">
                                <h5><i class="bi bi-cart-plus"></i> è´­ä¹°å•†å“</h5>
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">æ•°é‡</span>
                                            <input type="number" id="purchase-quantity" class="form-control" value="1" min="1">
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <span class="text-secondary me-2">æ€»ä»·:</span>
                                            <span id="purchase-total-price" class="text-danger fw-bold"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- å•†å“ä¿¡æ¯é€šè¿‡window.currentProductä¼ é€’ï¼Œä¸éœ€è¦éšè—å­—æ®µ -->
                                <div class="d-grid gap-2">
                                    <button id="btn-purchase" class="btn btn-primary" onclick="purchaseProduct()">
                                        <i class="bi bi-bag-check"></i> ç«‹å³è´­ä¹°
                                    </button>
                                </div>
                            </div>
                            
                            <div class="small text-muted mt-3">
                                <div>åˆ›å»ºæ—¶é—´: <span id="view-createTime"></span></div>
                                <div>æ›´æ–°æ—¶é—´: <span id="view-updateTime"></span></div>
                            </div>

                            <!-- ç¼“å­˜çŠ¶æ€æ˜¾ç¤º -->
                            <div class="mt-3 p-2 bg-info bg-opacity-10 border border-info rounded">
                                <small class="text-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>ç¼“å­˜çŠ¶æ€ï¼š</strong>å•†å“ä¿¡æ¯å·²ä»æ•°æ®åº“åŠ è½½å¹¶ç¼“å­˜åˆ°Redisï¼Œä¸‹æ¬¡è®¿é—®å°†æ›´å¿«ï¼
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤ä¸‹æ¶å•†å“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="removeProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¡®è®¤ä¸‹æ¶å•†å“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>ç¡®å®šè¦ä¸‹æ¶æ­¤å•†å“å—ï¼Ÿä¸‹æ¶åå•†å“å°†ä¸å†æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚</p>
                    <input type="hidden" id="remove-product-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" onclick="removeProduct()">ç¡®è®¤ä¸‹æ¶</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">Â© 2023 å•†å“åº“å­˜ç®¡ç†ç³»ç»Ÿ | åŸºäºSpring Bootå’ŒRedis</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // åˆ›å»ºå•†å“
        function createProduct() {
            const formData = {
                name: document.getElementById('name').value,
                price: document.getElementById('price').value,
                stock: document.getElementById('stock').value,
                imageUrl: document.getElementById('imageUrl').value,
                description: document.getElementById('description').value
            };

            axios.post('/api/products', formData)
                .then(response => {
                    if (response.data.code === 200) {
                        alert('å•†å“åˆ›å»ºæˆåŠŸï¼');
                        window.location.reload();
                    } else {
                        alert('åˆ›å»ºå¤±è´¥: ' + response.data.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€');
                });
        }

        // æŸ¥çœ‹å•†å“è¯¦æƒ…
        function viewProduct(id) {
            console.log('æŸ¥çœ‹å•†å“è¯¦æƒ…, ID:', id);

            // é€šè¿‡AJAXè·å–å•†å“ä¿¡æ¯ï¼Œç¡®ä¿ä»æ•°æ®åº“ç¼“å­˜åˆ°Redis
            axios.get(`/api/products/${id}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const product = response.data.data;

                        // æ£€æŸ¥å•†å“çŠ¶æ€
                        if (product.status !== 1) {
                            alert('è¯¥å•†å“å·²ä¸‹æ¶ï¼Œæ— æ³•æŸ¥çœ‹è¯¦æƒ…');
                            return;
                        }
                        console.log('è·å–å•†å“ä¿¡æ¯æˆåŠŸ:', product);

                        // å¡«å……æ¨¡æ€æ¡†æ•°æ®
                        document.getElementById('view-name').textContent = product.name;
                        document.getElementById('view-price').textContent = 'Â¥' + product.price;
                        document.getElementById('view-stock').textContent = product.stock;
                        document.getElementById('view-description').textContent = product.description || 'æš‚æ— æè¿°';
                        document.getElementById('view-createTime').textContent = product.createTime;
                        document.getElementById('view-updateTime').textContent = product.updateTime || 'æš‚æ— æ›´æ–°';

                        // è®¾ç½®å•†å“å›¾ç‰‡
                        const imageElement = document.getElementById('view-image');
                        if (product.imageUrl) {
                            imageElement.src = product.imageUrl;
                        } else {
                            imageElement.src = 'https://via.placeholder.com/300x200?text=æš‚æ— å›¾ç‰‡';
                        }

                        // è®¾ç½®çŠ¶æ€æ ‡ç­¾
                        const statusElement = document.getElementById('view-status');
                        if (product.status === 1) {
                            statusElement.className = 'badge bg-success me-2';
                            statusElement.textContent = 'å·²ä¸Šæ¶';
                        } else {
                            statusElement.className = 'badge bg-secondary me-2';
                            statusElement.textContent = 'å·²ä¸‹æ¶';
                        }

                        // è®¾ç½®è´­ä¹°åŒºåŸŸçš„å•†å“IDå’Œå•ä»·
                        document.getElementById('purchase-quantity').value = 1;
                        updateTotalPrice(product.price);

                        // å­˜å‚¨å•†å“ä¿¡æ¯ä¾›è´­ä¹°ä½¿ç”¨
                        window.currentProduct = product;

                        // æ˜¾ç¤ºæ¨¡æ€æ¡†
                        const modal = new bootstrap.Modal(document.getElementById('viewProductModal'));
                        modal.show();

                        // åœ¨æ§åˆ¶å°æ˜¾ç¤ºç¼“å­˜çŠ¶æ€ä¿¡æ¯
                        console.log('âœ… å•†å“ä¿¡æ¯å·²ä»æ•°æ®åº“åŠ è½½å¹¶ç¼“å­˜åˆ°Redis');
                        console.log('ğŸ“¦ å•†å“è¯¦æƒ…:', {
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            stock: product.stock,
                            status: product.status === 1 ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶'
                        });

                        // æ£€æŸ¥å¹¶æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
                        checkCacheStatus(product.id);

                    } else {
                        console.error('è·å–å•†å“ä¿¡æ¯å¤±è´¥:', response.data.message);
                        alert('è·å–å•†å“ä¿¡æ¯å¤±è´¥: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('è¯·æ±‚å¤±è´¥:', error);
                    alert('è·å–å•†å“ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
        }
        
        // æ›´æ–°æ€»ä»·
        function updateTotalPrice(unitPrice) {
            const quantity = document.getElementById('purchase-quantity').value;
            const totalPrice = (parseFloat(unitPrice) * parseInt(quantity)).toFixed(2);
            document.getElementById('purchase-total-price').textContent = `Â¥${totalPrice}`;
        }
        
        // è´­ä¹°å•†å“
        function purchaseProduct() {
            // ä½¿ç”¨å½“å‰æŸ¥çœ‹çš„å•†å“ä¿¡æ¯
            if (!window.currentProduct) {
                alert('è¯·å…ˆé€‰æ‹©è¦è´­ä¹°çš„å•†å“');
                return;
            }

            const quantity = parseInt(document.getElementById('purchase-quantity').value);

            // éªŒè¯æ•°é‡
            if (quantity < 1) {
                alert('è´­ä¹°æ•°é‡å¿…é¡»å¤§äº0');
                return;
            }

            // æ£€æŸ¥åº“å­˜
            if (quantity > window.currentProduct.stock) {
                alert(`åº“å­˜ä¸è¶³ï¼å½“å‰åº“å­˜ï¼š${window.currentProduct.stock}`);
                return;
            }

            // åˆ›å»ºè®¢å•è¯·æ±‚
            const orderData = {
                productId: window.currentProduct.id,
                quantity: quantity
            };

            console.log('åˆ›å»ºè®¢å•:', orderData);
            
            // å‘é€åˆ›å»ºè®¢å•è¯·æ±‚
            axios.post('/api/orders', orderData)
                .then(response => {
                    if (response.data.code === 200) {
                        const orderInfo = response.data.data;
                        alert(`è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·: ${orderInfo.orderNo}`);
                        
                        // æ˜¾ç¤ºæ”¯ä»˜é€‰æ‹©å¯¹è¯æ¡†
                        showPaymentDialog(orderInfo);
                    } else {
                        alert('åˆ›å»ºè®¢å•å¤±è´¥: ' + response.data.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.response && error.response.data) {
                        alert('åˆ›å»ºè®¢å•å¤±è´¥: ' + error.response.data.message);
                    } else {
                        alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€');
                    }
                });
        }

        // ç¼–è¾‘å•†å“
        function editProduct(id) {
            axios.get(`/api/products/${id}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const product = response.data.data;
                        document.getElementById('edit-id').value = product.id;
                        document.getElementById('edit-name').value = product.name;
                        document.getElementById('edit-price').value = product.price;
                        document.getElementById('edit-stock').value = product.stock;
                        document.getElementById('edit-imageUrl').value = product.imageUrl || '';
                        document.getElementById('edit-description').value = product.description;
                        
                        const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
                        editModal.show();
                    } else {
                        alert('è·å–å•†å“ä¿¡æ¯å¤±è´¥: ' + response.data.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('è·å–å•†å“ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€');
                });
        }

        // æ›´æ–°å•†å“ä¿¡æ¯
        function updateProduct() {
            const id = document.getElementById('edit-id').value;
            const formData = {
                name: document.getElementById('edit-name').value,
                price: document.getElementById('edit-price').value,
                stock: document.getElementById('edit-stock').value,
                imageUrl: document.getElementById('edit-imageUrl').value,
                description: document.getElementById('edit-description').value
            };

            axios.put(`/api/products/${id}`, formData)
                .then(response => {
                    if (response.data.code === 200) {
                        alert('å•†å“æ›´æ–°æˆåŠŸï¼');
                        window.location.reload();
                    } else {
                        alert('æ›´æ–°å¤±è´¥: ' + response.data.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€');
                });
        }

        // ç¡®è®¤ä¸‹æ¶å•†å“
        function confirmRemoveProduct(id) {
            document.getElementById('remove-product-id').value = id;
            const removeModal = new bootstrap.Modal(document.getElementById('removeProductModal'));
            removeModal.show();
        }

        // ä¸‹æ¶å•†å“
        function removeProduct() {
            const id = document.getElementById('remove-product-id').value;
            
            axios.delete(`/api/products/${id}`)
                .then(response => {
                    if (response.data.code === 200) {
                        alert('å•†å“å·²ä¸‹æ¶ï¼');
                        window.location.reload();
                    } else {
                        alert('ä¸‹æ¶å¤±è´¥: ' + response.data.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ä¸‹æ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€');
                });
        }

        // é‡æ–°ä¸Šæ¶å•†å“
        function restoreProduct(id) {
            // è¿™é‡Œå‡è®¾æœ‰ä¸€ä¸ªæ¢å¤å•†å“çš„API
            axios.post(`/api/products/${id}/restore`)
                .then(response => {
                    if (response.data.code === 200) {
                        alert('å•†å“å·²é‡æ–°ä¸Šæ¶ï¼');
                        window.location.reload();
                    } else {
                        alert('ä¸Šæ¶å¤±è´¥: ' + response.data.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ä¸Šæ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€');
                });
        }

        // æ¸…é™¤å•†å“ç¼“å­˜
        function clearProductCache(id) {
            axios.post(`/api/products/${id}/clear-cache`)
                .then(response => {
                    if (response.data.code === 200) {
                        alert('å•†å“ç¼“å­˜å·²æ¸…é™¤ï¼');
                    } else {
                        alert('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + response.data.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ¸…é™¤ç¼“å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€');
                });
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'æœªçŸ¥';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ˜¾ç¤ºæ”¯ä»˜å¯¹è¯æ¡†
        function showPaymentDialog(orderInfo) {
            const message = `è®¢å•åˆ›å»ºæˆåŠŸï¼\nè®¢å•å·: ${orderInfo.orderNo}\næ€»é‡‘é¢: Â¥${orderInfo.totalAmount}\n\nè¯·é€‰æ‹©æ“ä½œï¼š`;

            if (confirm(message + '\n\nç‚¹å‡»"ç¡®å®š"ç«‹å³æ”¯ä»˜ï¼Œç‚¹å‡»"å–æ¶ˆ"ç¨åæ”¯ä»˜')) {
                // ç”¨æˆ·é€‰æ‹©ç«‹å³æ”¯ä»˜
                payOrder(orderInfo.orderNo);
            } else {
                // ç”¨æˆ·é€‰æ‹©ç¨åæ”¯ä»˜
                alert('è®¢å•å·²åˆ›å»ºï¼Œæ‚¨å¯ä»¥ç¨ååœ¨è®¢å•ç®¡ç†é¡µé¢è¿›è¡Œæ”¯ä»˜ã€‚\næ³¨æ„ï¼šè®¢å•å°†åœ¨30åˆ†é’Ÿåè‡ªåŠ¨å–æ¶ˆã€‚');

                // å…³é—­å•†å“è¯¦æƒ…æ¨¡æ€æ¡†
                const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewProductModal'));
                if (viewModal) {
                    viewModal.hide();
                }

                // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°åº“å­˜æ˜¾ç¤º
                location.reload();
            }
        }

        // æ”¯ä»˜è®¢å•
        function payOrder(orderNo) {
            console.log('å¼€å§‹æ”¯ä»˜è®¢å•:', orderNo);

            const paymentData = {
                orderNo: orderNo
            };

            axios.post('/api/orders/payment', paymentData)
                .then(response => {
                    if (response.data.code === 200) {
                        alert('æ”¯ä»˜æˆåŠŸï¼è®¢å•å·²å®Œæˆã€‚');
                        console.log('âœ… æ”¯ä»˜æˆåŠŸ - Redisåº“å­˜å·²æ‰£å‡ï¼Œæ•°æ®åº“åº“å­˜å·²æ‰£å‡');

                        // å…³é—­å•†å“è¯¦æƒ…æ¨¡æ€æ¡†
                        const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewProductModal'));
                        if (viewModal) {
                            viewModal.hide();
                        }

                        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°åº“å­˜æ˜¾ç¤º
                        location.reload();
                    } else {
                        alert('æ”¯ä»˜å¤±è´¥: ' + response.data.message);

                        // æ”¯ä»˜å¤±è´¥ï¼Œè¯¢é—®æ˜¯å¦å–æ¶ˆè®¢å•
                        if (confirm('æ”¯ä»˜å¤±è´¥ï¼Œæ˜¯å¦å–æ¶ˆè®¢å•ï¼Ÿ\nå–æ¶ˆè®¢å•å°†é‡Šæ”¾é”å®šçš„åº“å­˜ã€‚')) {
                            cancelOrder(orderNo);
                        }
                    }
                })
                .catch(error => {
                    console.error('æ”¯ä»˜è¯·æ±‚å¤±è´¥:', error);
                    alert('æ”¯ä»˜è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');

                    // æ”¯ä»˜è¯·æ±‚å¤±è´¥ï¼Œè¯¢é—®æ˜¯å¦å–æ¶ˆè®¢å•
                    if (confirm('æ”¯ä»˜è¯·æ±‚å¤±è´¥ï¼Œæ˜¯å¦å–æ¶ˆè®¢å•ï¼Ÿ\nå–æ¶ˆè®¢å•å°†é‡Šæ”¾é”å®šçš„åº“å­˜ã€‚')) {
                        cancelOrder(orderNo);
                    }
                });
        }

        // å–æ¶ˆè®¢å•
        function cancelOrder(orderNo) {
            console.log('å¼€å§‹å–æ¶ˆè®¢å•:', orderNo);

            axios.post(`/api/orders/cancel/${orderNo}`)
                .then(response => {
                    if (response.data.code === 200) {
                        alert('è®¢å•å·²å–æ¶ˆï¼Œåº“å­˜å·²é‡Šæ”¾ã€‚');
                        console.log('âœ… è®¢å•å–æ¶ˆæˆåŠŸ - Redisåº“å­˜å·²å›æ»š');

                        // å…³é—­å•†å“è¯¦æƒ…æ¨¡æ€æ¡†
                        const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewProductModal'));
                        if (viewModal) {
                            viewModal.hide();
                        }

                        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°åº“å­˜æ˜¾ç¤º
                        location.reload();
                    } else {
                        alert('å–æ¶ˆè®¢å•å¤±è´¥: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('å–æ¶ˆè®¢å•è¯·æ±‚å¤±è´¥:', error);
                    alert('å–æ¶ˆè®¢å•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
        }

        // æ˜¾ç¤ºä¸‹æ¶å•†å“æç¤º
        function showOfflineMessage() {
            alert('è¯¥å•†å“å·²ä¸‹æ¶ï¼Œæ— æ³•æŸ¥çœ‹è¯¦æƒ…');
        }

        // æ£€æŸ¥ç¼“å­˜çŠ¶æ€
        function checkCacheStatus(productId) {
            axios.get(`/api/products/${productId}/cache-status`)
                .then(response => {
                    if (response.data.code === 200) {
                        const status = response.data.data;
                        console.log('ğŸ” ç¼“å­˜çŠ¶æ€æ£€æŸ¥ç»“æœ:', status);

                        // æ›´æ–°ç¼“å­˜çŠ¶æ€æ˜¾ç¤º
                        const cacheStatusDiv = document.querySelector('.bg-info.bg-opacity-10');
                        if (cacheStatusDiv) {
                            let statusText = '';
                            if (status.productCached && status.stockCached) {
                                statusText = `âœ… å•†å“ä¿¡æ¯å’Œåº“å­˜å·²ç¼“å­˜åˆ°Redis (åº“å­˜: ${status.stockValue}) - ${status.timestamp}`;
                                cacheStatusDiv.className = 'mt-3 p-2 bg-success bg-opacity-10 border border-success rounded';
                                cacheStatusDiv.innerHTML = `<small class="text-success"><i class="bi bi-check-circle"></i> <strong>ç¼“å­˜çŠ¶æ€ï¼š</strong>${statusText}</small>`;
                            } else if (status.productCached) {
                                statusText = `âš ï¸ å•†å“ä¿¡æ¯å·²ç¼“å­˜ï¼Œä½†åº“å­˜æœªç¼“å­˜ - ${status.timestamp}`;
                                cacheStatusDiv.className = 'mt-3 p-2 bg-warning bg-opacity-10 border border-warning rounded';
                                cacheStatusDiv.innerHTML = `<small class="text-warning"><i class="bi bi-exclamation-triangle"></i> <strong>ç¼“å­˜çŠ¶æ€ï¼š</strong>${statusText}</small>`;
                            } else {
                                statusText = `âŒ å•†å“ä¿¡æ¯æœªç¼“å­˜åˆ°Redis - ${status.timestamp}`;
                                cacheStatusDiv.className = 'mt-3 p-2 bg-danger bg-opacity-10 border border-danger rounded';
                                cacheStatusDiv.innerHTML = `<small class="text-danger"><i class="bi bi-x-circle"></i> <strong>ç¼“å­˜çŠ¶æ€ï¼š</strong>${statusText}</small>`;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('æ£€æŸ¥ç¼“å­˜çŠ¶æ€å¤±è´¥:', error);
                });
        }
    </script>
</body>
</html>