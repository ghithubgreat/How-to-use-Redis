<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>库存状态监控 - 商品库存管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-box-seam"></i> 商品库存管理系统
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor/stock">库存监控</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/product/list">商品管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/monitor/stock-status">库存状态</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-graph-up"></i> 库存状态监控</h2>
            <button type="button" class="btn btn-primary" onclick="refreshAll()">
                <i class="bi bi-arrow-clockwise"></i> 刷新所有
            </button>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>库存查询</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="productId" class="form-label">商品ID</label>
                            <input type="number" class="form-control" id="productId" placeholder="输入商品ID" value="1">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-info" onclick="checkAllStock()">
                                <i class="bi bi-search"></i> 查询所有库存状态
                            </button>
                            <button class="btn btn-success" onclick="syncToRedis()">
                                <i class="bi bi-arrow-repeat"></i> 同步到Redis
                            </button>
                            <button class="btn btn-warning" onclick="cleanExpiredLocks()">
                                <i class="bi bi-clock"></i> 清理过期锁定
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>库存状态</h5>
                    </div>
                    <div class="card-body">
                        <div id="stock-status" class="border p-3 bg-light" style="height: 300px; overflow-y: auto;">
                            <strong>库存状态信息：</strong><br>
                            点击左侧按钮查询库存状态...<br>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>库存管理策略说明</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle"></i> 新的库存管理策略：</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <strong>1. 下单扣Redis</strong>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">快速锁定库存，保障并发性能</p>
                                            <ul class="small">
                                                <li>用户下单时立即扣减Redis库存</li>
                                                <li>创建库存锁定记录</li>
                                                <li>保证高并发下的性能</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <strong>2. 支付扣数据库</strong>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">最终一致性落地，Redis无需重复扣减</p>
                                            <ul class="small">
                                                <li>支付成功时扣减数据库库存</li>
                                                <li>更新锁定状态为已扣减</li>
                                                <li>保证数据最终一致性</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <strong>3. 取消回滚Redis</strong>
                                        </div>
                                        <div class="card-body">
                                            <p class="card-text">释放锁定库存</p>
                                            <ul class="small">
                                                <li>取消订单时回滚Redis库存</li>
                                                <li>释放库存锁定记录</li>
                                                <li>自动清理过期锁定</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-outline-primary me-2" onclick="testFlow()">
                                测试完整流程
                            </button>
                            <a href="/product/detail/1" class="btn btn-outline-success me-2" target="_blank">
                                打开商品详情页
                            </a>
                            <a href="/product/list" class="btn btn-outline-info">
                                返回商品列表
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        function log(message, type = 'info') {
            const statusDiv = document.getElementById('stock-status');
            const time = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
            statusDiv.innerHTML += `<span class="${colorClass}">[${time}] ${message}</span><br>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        function getProductId() {
            const id = document.getElementById('productId').value;
            if (!id) {
                alert('请输入商品ID');
                return null;
            }
            return parseInt(id);
        }
        
        function checkAllStock() {
            const productId = getProductId();
            if (!productId) return;
            
            log(`=== 查询商品${productId}的所有库存状态 ===`);
            
            // 查询数据库库存
            axios.get(`/api/products/${productId}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const product = response.data.data;
                        log(`📦 数据库库存: ${product.stock}`, 'info');
                    } else {
                        log(`❌ 获取数据库库存失败: ${response.data.message}`, 'error');
                    }
                })
                .catch(error => {
                    log(`❌ 数据库查询失败: ${error.message}`, 'error');
                });
            
            // 查询Redis可用库存
            setTimeout(() => {
                axios.get(`/api/products/${productId}/available-stock`)
                    .then(response => {
                        if (response.data.code === 200) {
                            const availableStock = response.data.data;
                            log(`🔄 Redis可用库存: ${availableStock}`, 'success');
                        } else {
                            log(`❌ 获取Redis库存失败: ${response.data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        log(`❌ Redis查询失败: ${error.message}`, 'error');
                    });
            }, 200);
            
            // 查询锁定库存
            setTimeout(() => {
                axios.get(`/api/products/${productId}/locked-stock`)
                    .then(response => {
                        if (response.data.code === 200) {
                            const lockedStock = response.data.data;
                            log(`🔒 锁定库存: ${lockedStock}`, 'warning');
                        } else {
                            log(`❌ 获取锁定库存失败: ${response.data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        log(`❌ 锁定库存查询失败: ${error.message}`, 'error');
                    });
            }, 400);
        }
        
        function syncToRedis() {
            const productId = getProductId();
            if (!productId) return;
            
            log(`同步商品${productId}的库存到Redis...`);
            
            axios.post(`/api/products/${productId}/sync-to-redis`)
                .then(response => {
                    if (response.data.code === 200) {
                        log(`✅ 同步成功`, 'success');
                        // 同步后查询状态
                        setTimeout(() => checkAllStock(), 500);
                    } else {
                        log(`❌ 同步失败: ${response.data.message}`, 'error');
                    }
                })
                .catch(error => {
                    log(`❌ 同步请求失败: ${error.message}`, 'error');
                });
        }
        
        function cleanExpiredLocks() {
            log(`清理过期的库存锁定...`);
            
            axios.post(`/api/products/clean-expired-locks`)
                .then(response => {
                    if (response.data.code === 200) {
                        const cleanedCount = response.data.data;
                        log(`✅ 清理完成，共清理 ${cleanedCount} 条过期锁定`, 'success');
                    } else {
                        log(`❌ 清理失败: ${response.data.message}`, 'error');
                    }
                })
                .catch(error => {
                    log(`❌ 清理请求失败: ${error.message}`, 'error');
                });
        }
        
        function testFlow() {
            log(`=== 开始测试完整库存管理流程 ===`);
            log(`1. 首先查询初始状态`);
            checkAllStock();
            
            setTimeout(() => {
                log(`2. 建议手动测试：`);
                log(`   - 打开商品详情页进行下单测试`);
                log(`   - 观察Redis库存的变化`);
                log(`   - 测试支付和取消订单的效果`);
            }, 2000);
        }
        
        function refreshAll() {
            document.getElementById('stock-status').innerHTML = '<strong>库存状态信息：</strong><br>';
            log('页面已刷新');
        }
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('库存状态监控页面已加载');
            log('新的库存管理策略已启用：下单扣Redis → 支付扣数据库 → 取消回滚Redis');
        });
    </script>
</body>
</html>
