<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQæ¶ˆæ¯ç›‘æ§ - åº“å­˜ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .stats-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .log-container {
            height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .log-info { background-color: #d1ecf1; color: #0c5460; }
        .log-success { background-color: #d4edda; color: #155724; }
        .log-warning { background-color: #fff3cd; color: #856404; }
        .log-error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-gear-fill"></i> åº“å­˜ç®¡ç†ç³»ç»Ÿ
            </a>
            <div class="navbar-nav ms-auto">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/product/list">å•†å“ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor/stock">åº“å­˜ç›‘æ§</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor/stock-log">åº“å­˜æµæ°´</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitor/redis-cache">Redisç¼“å­˜</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/monitor/mq-status">MQç›‘æ§</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-broadcast"></i> MQæ¶ˆæ¯ç›‘æ§</h2>
                    <div>
                        <button class="btn btn-outline-primary" onclick="refreshStatus()">
                            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°çŠ¶æ€
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> æ¸…ç©ºæ—¥å¿—
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MQçŠ¶æ€ç»Ÿè®¡ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center stats-card">
                    <div class="card-body">
                        <h5 class="card-title text-primary">MQçŠ¶æ€</h5>
                        <h3 class="card-text" id="mqStatus">æ£€æŸ¥ä¸­...</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center stats-card">
                    <div class="card-body">
                        <h5 class="card-title text-success">æ‰£å‡æ¶ˆæ¯</h5>
                        <h3 class="card-text" id="deductionCount">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center stats-card">
                    <div class="card-body">
                        <h5 class="card-title text-warning">å›æ»šæ¶ˆæ¯</h5>
                        <h3 class="card-text" id="rollbackCount">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center stats-card">
                    <div class="card-body">
                        <h5 class="card-title text-info">é˜Ÿåˆ—çŠ¶æ€</h5>
                        <h3 class="card-text" id="queueStatus">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•æ“ä½œé¢æ¿ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-play-circle"></i> MQæ¶ˆæ¯æµ‹è¯•</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">å•†å“ID</label>
                                <input type="number" class="form-control" id="testProductId" value="1" placeholder="è¾“å…¥å•†å“ID">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">æ•°é‡</label>
                                <input type="number" class="form-control" id="testQuantity" value="1" placeholder="è¾“å…¥æ•°é‡">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">è®¢å•å·</label>
                                <input type="text" class="form-control" id="testOrderNo" placeholder="è¾“å…¥è®¢å•å·ï¼ˆå¯é€‰ï¼‰">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">æ“ä½œ</label>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="testDeductionMessage()">
                                        <i class="bi bi-arrow-down"></i> æµ‹è¯•æ‰£å‡
                                    </button>
                                    <button class="btn btn-warning" onclick="testRollbackMessage()">
                                        <i class="bi bi-arrow-up"></i> æµ‹è¯•å›æ»š
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ—¥å¿— -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-journal-text"></i> MQæ¶ˆæ¯æ—¥å¿—</h5>
                    </div>
                    <div class="card-body">
                        <div id="mqLogs" class="log-container">
                            <div class="log-entry log-info">
                                <strong>[ç³»ç»Ÿ]</strong> MQç›‘æ§é¡µé¢å·²åŠ è½½ï¼Œç­‰å¾…æ¶ˆæ¯...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let deductionMessageCount = 0;
        let rollbackMessageCount = 0;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
            setInterval(refreshStatus, 5000);
        });

        // åˆ·æ–°MQçŠ¶æ€
        function refreshStatus() {
            // è·å–MQçŠ¶æ€
            axios.get('/api/mq/status')
                .then(response => {
                    if (response.data.code === 200) {
                        const data = response.data.data;
                        document.getElementById('mqStatus').textContent = data.mode;
                        document.getElementById('queueStatus').textContent = data.queueInfo;
                    } else {
                        document.getElementById('mqStatus').textContent = 'è·å–å¤±è´¥';
                        document.getElementById('queueStatus').textContent = 'æœªçŸ¥';
                    }
                })
                .catch(error => {
                    console.error('è·å–MQçŠ¶æ€å¤±è´¥:', error);
                    document.getElementById('mqStatus').textContent = 'è¿æ¥å¤±è´¥';
                    document.getElementById('queueStatus').textContent = 'é”™è¯¯';
                });

            // è·å–MQç»Ÿè®¡æ•°æ®
            axios.get('/api/mq/statistics')
                .then(response => {
                    if (response.data.code === 200) {
                        const statistics = response.data.data;
                        deductionMessageCount = statistics.deductionCount;
                        rollbackMessageCount = statistics.rollbackCount;

                        document.getElementById('deductionCount').textContent = deductionMessageCount;
                        document.getElementById('rollbackCount').textContent = rollbackMessageCount;

                        // æ›´æ–°æ—¥å¿—
                        updateLogs(statistics.logs);
                    }
                })
                .catch(error => {
                    console.error('è·å–MQç»Ÿè®¡å¤±è´¥:', error);
                });
        }

        // æµ‹è¯•æ‰£å‡æ¶ˆæ¯
        function testDeductionMessage() {
            const productId = document.getElementById('testProductId').value;
            const quantity = document.getElementById('testQuantity').value;
            const orderNo = document.getElementById('testOrderNo').value;

            if (!productId || !quantity) {
                alert('è¯·è¾“å…¥å•†å“IDå’Œæ•°é‡');
                return;
            }

            const params = new URLSearchParams();
            params.append('productId', productId);
            params.append('quantity', quantity);
            if (orderNo) params.append('orderNo', orderNo);

            axios.post('/api/mq/test/deduction', params)
                .then(response => {
                    if (response.data.code === 200) {
                        addLog('success', `âœ… ${response.data.data}`);
                        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                        setTimeout(refreshStatus, 500);
                    } else {
                        addLog('error', `âŒ å‘é€å¤±è´¥: ${response.data.message}`);
                    }
                })
                .catch(error => {
                    addLog('error', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
                });
        }

        // æµ‹è¯•å›æ»šæ¶ˆæ¯
        function testRollbackMessage() {
            const productId = document.getElementById('testProductId').value;
            const quantity = document.getElementById('testQuantity').value;
            const orderNo = document.getElementById('testOrderNo').value;

            if (!productId || !quantity) {
                alert('è¯·è¾“å…¥å•†å“IDå’Œæ•°é‡');
                return;
            }

            const params = new URLSearchParams();
            params.append('productId', productId);
            params.append('quantity', quantity);
            if (orderNo) params.append('orderNo', orderNo);

            axios.post('/api/mq/test/rollback', params)
                .then(response => {
                    if (response.data.code === 200) {
                        addLog('warning', `ğŸ”„ ${response.data.data}`);
                        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                        setTimeout(refreshStatus, 500);
                    } else {
                        addLog('error', `âŒ å‘é€å¤±è´¥: ${response.data.message}`);
                    }
                })
                .catch(error => {
                    addLog('error', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
                });
        }

        // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        function updateLogs(logs) {
            const logsContainer = document.getElementById('mqLogs');

            // å¦‚æœæœ‰æ–°çš„æ—¥å¿—æ•°æ®ï¼Œæ›´æ–°æ˜¾ç¤º
            if (logs && logs.length > 0) {
                // æ¸…ç©ºç°æœ‰æ—¥å¿—
                logsContainer.innerHTML = '';

                // æ·»åŠ æ‰€æœ‰æ—¥å¿—æ¡ç›®
                logs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry log-${log.type}`;
                    logEntry.innerHTML = `<strong>[${log.timestamp}]</strong> ${log.message}`;
                    logsContainer.appendChild(logEntry);
                });

                // æ»šåŠ¨åˆ°åº•éƒ¨
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(type, message) {
            const logsContainer = document.getElementById('mqLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;

            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            axios.post('/api/mq/clear')
                .then(response => {
                    if (response.data.code === 200) {
                        addLog('info', 'ğŸ§¹ ' + response.data.data);
                        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                        setTimeout(refreshStatus, 500);
                    } else {
                        addLog('error', `âŒ æ¸…ç©ºå¤±è´¥: ${response.data.message}`);
                    }
                })
                .catch(error => {
                    addLog('error', `âŒ æ¸…ç©ºè¯·æ±‚å¤±è´¥: ${error.message}`);
                });
        }
    </script>
</body>
</html>
