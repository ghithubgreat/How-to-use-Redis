<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品数据调试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2>商品数据调试页面</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>后端数据 (Thymeleaf)</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tr>
                                <td><strong>商品对象是否存在</strong></td>
                                <td th:text="${product != null ? '是' : '否'}">否</td>
                            </tr>
                            <tr th:if="${product != null}">
                                <td><strong>商品ID</strong></td>
                                <td th:text="${product.id}">N/A</td>
                            </tr>
                            <tr th:if="${product != null}">
                                <td><strong>商品名称</strong></td>
                                <td th:text="${product.name}">N/A</td>
                            </tr>
                            <tr th:if="${product != null}">
                                <td><strong>商品价格</strong></td>
                                <td th:text="${product.price}">N/A</td>
                            </tr>
                            <tr th:if="${product != null}">
                                <td><strong>商品库存</strong></td>
                                <td th:text="${product.stock}">N/A</td>
                            </tr>
                            <tr th:if="${product != null}">
                                <td><strong>商品状态</strong></td>
                                <td th:text="${product.status}">N/A</td>
                            </tr>
                            <tr th:if="${product != null}">
                                <td><strong>状态描述</strong></td>
                                <td th:text="${product.status == 1 ? '上架' : '下架'}">N/A</td>
                            </tr>
                            <tr th:if="${product != null}">
                                <td><strong>商品描述</strong></td>
                                <td th:text="${product.description}">N/A</td>
                            </tr>
                            <tr th:if="${product != null}">
                                <td><strong>图片URL</strong></td>
                                <td th:text="${product.imageUrl}">N/A</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>JavaScript变量</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered" id="js-data-table">
                            <tr>
                                <td><strong>maxStock</strong></td>
                                <td id="js-maxStock">加载中...</td>
                            </tr>
                            <tr>
                                <td><strong>productStatus</strong></td>
                                <td id="js-productStatus">加载中...</td>
                            </tr>
                            <tr>
                                <td><strong>productId</strong></td>
                                <td id="js-productId">加载中...</td>
                            </tr>
                        </table>
                        
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="refreshJSData()">刷新JS数据</button>
                            <button class="btn btn-secondary" onclick="testQuantityButtons()">测试数量按钮</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>数量选择器测试</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${product != null and product.status == 1 and product.stock > 0}">
                            <div class="quantity-selector d-flex align-items-center gap-2">
                                <label class="form-label">购买数量：</label>
                                <button type="button" class="btn btn-outline-secondary" onclick="decreaseQuantity()">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input type="number" id="quantity" class="form-control" style="width: 80px; text-align: center;" 
                                       value="1" min="1" th:max="${product.stock}" step="1">
                                <button type="button" class="btn btn-outline-secondary" onclick="increaseQuantity()">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <span class="text-muted">库存 <span th:text="${product.stock}">0</span> 件</span>
                            </div>
                            
                            <div class="mt-3">
                                <button type="button" class="btn btn-success" onclick="buyNow()">
                                    <i class="bi bi-cart-plus"></i> 立即购买
                                </button>
                            </div>
                        </div>
                        
                        <div th:if="${product == null}" class="alert alert-danger">
                            商品不存在
                        </div>
                        
                        <div th:if="${product != null and product.status != 1}" class="alert alert-warning">
                            商品已下架
                        </div>
                        
                        <div th:if="${product != null and product.stock <= 0}" class="alert alert-warning">
                            商品缺货
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>操作日志</h5>
                    </div>
                    <div class="card-body">
                        <div id="log" class="border p-3 bg-light" style="height: 200px; overflow-y: auto;">
                            <strong>操作日志：</strong><br>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const maxStock = /*[[${product != null ? product.stock : 0}]]*/ 0;
        const productStatus = /*[[${product != null ? product.status : 0}]]*/ 0;
        const productId = /*[[${product != null ? product.id : 0}]]*/ 0;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function refreshJSData() {
            document.getElementById('js-maxStock').textContent = maxStock;
            document.getElementById('js-productStatus').textContent = productStatus + (productStatus === 1 ? ' (上架)' : ' (下架)');
            document.getElementById('js-productId').textContent = productId;
            log('JavaScript数据已刷新');
        }
        
        function decreaseQuantity() {
            log('decreaseQuantity() 被调用');
            const input = document.getElementById('quantity');
            if (!input) {
                log('错误：找不到数量输入框');
                return;
            }
            
            const currentValue = parseInt(input.value) || 1;
            log(`当前数量: ${currentValue}`);
            
            if (currentValue > 1) {
                input.value = currentValue - 1;
                log(`数量减少到: ${input.value}`);
            } else {
                log('无法减少 - 最小数量为1');
            }
        }
        
        function increaseQuantity() {
            log('increaseQuantity() 被调用');
            const input = document.getElementById('quantity');
            if (!input) {
                log('错误：找不到数量输入框');
                return;
            }
            
            const currentValue = parseInt(input.value) || 1;
            log(`当前数量: ${currentValue}, 最大库存: ${maxStock}`);
            
            if (currentValue < maxStock) {
                input.value = currentValue + 1;
                log(`数量增加到: ${input.value}`);
            } else {
                log(`无法增加 - 已达到最大库存 ${maxStock}`);
                alert(`最大库存数量为 ${maxStock}`);
            }
        }
        
        function buyNow() {
            const quantity = document.getElementById('quantity').value;
            
            log('buyNow() 被调用');
            log(`购买数量: ${quantity}`);
            log(`商品ID: ${productId}`);
            log(`商品状态: ${productStatus}`);
            
            if (productStatus !== 1) {
                alert('商品已下架，无法购买');
                log('购买失败：商品已下架');
                return;
            }
            
            if (quantity < 1 || quantity > maxStock) {
                alert('请选择正确的购买数量');
                log('购买失败：数量不正确');
                return;
            }
            
            log('开始创建订单...');
            alert(`模拟购买成功！商品ID: ${productId}, 数量: ${quantity}`);
        }
        
        function testQuantityButtons() {
            log('=== 开始测试数量按钮 ===');
            const input = document.getElementById('quantity');
            if (input) {
                input.value = 1;
                log('重置数量为1');
                
                increaseQuantity();
                setTimeout(() => {
                    decreaseQuantity();
                    log('=== 测试完成 ===');
                }, 500);
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成');
            refreshJSData();
            log(`商品数据初始化完成 - ID: ${productId}, 状态: ${productStatus}, 库存: ${maxStock}`);
        });
        /*]]>*/
    </script>
</body>
</html>
